# План рефакторинга и улучшения архитектуры

Этот документ содержит пошаговый план по улучшению кодовой базы проекта `dream-boat-snaps-discover`. Каждый пункт представляет собой отдельную задачу.

---

### **Этап 1: Устранение уязвимости безопасности (Приоритет: Критический)**

- [x] **1.1. Создать прокси-функцию в Supabase:**
  - Создать новую облачную функцию `/supabase/functions/proxy-n8n-webhook/index.ts`.
  - Эта функция будет принимать запрос от клиента, безопасно добавлять секретный токен `N8N_SECRET_TOKEN` (из переменных окружения Supabase) и перенаправлять запрос в n8n.
  - **Прогресс:**
    - **Локальный код создан:** Написан и сохранен код для функции `proxy-n8n-webhook/index.ts`.
    - **Настроены секреты:** В панели управления Supabase для этой функции были установлены необходимые секреты: `N8N_WEBHOOK_URL` и `N8N_SECRET_TOKEN`.
    - **Функция развернута:** С помощью Supabase CLI локальный код был успешно отправлен и активирован в облаке Supabase. Серверная часть готова к работе.
  - **Следующий шаг:** Обновить клиентскую часть приложения (фронтенд), чтобы она отправляла запросы на эту новую, безопасную функцию, а не напрямую в n8n.

- [x] **1.2. Обновить клиентский код:**
  - Изменить логику в хуке `useSearch.ts` (или на странице `Index.tsx`), чтобы вместо прямого запроса к n8n вызывалась новая Supabase-функция `proxy-n8n-webhook`.

- [x] **1.3. Удалить секретный токен с клиента:**
  - Полностью удалить переменную `VITE_N8N_SECRET_TOKEN` из файлов `.env`, `.env.example` и `vite-env.d.ts`.

---

### **Этап 2: Реорганизация структуры проекта**

- [ ] **2.1. Централизовать конфигурацию:**
  - Создать файл `src/config/env.ts` для экспорта всех клиентских переменных окружения (`VITE_`).
  - Заменить все прямые вызовы `import.meta.env` на импорты из `src/config/env.ts`.

- [ ] **2.2. Структурировать API-логику:**
  - Создать директорию `src/api`.
  - Перенести `src/lib/supabase.ts` в `src/api/supabase.ts`.

- [ ] **2.3. Очистить `App.tsx`:**
  - Создать директорию `src/providers`.
  - Вынести всю логику провайдеров (`QueryClientProvider`, `ThemeProvider`, `AuthProvider` и др.) из `App.tsx` в новый компонент `src/providers/AppProviders.tsx`.
  - В `App.tsx` оставить только роутинг, обернутый в `AppProviders`.

- [ ] **2.4. Оптимизировать утилиты и стили:**
  - Переместить `src/lib/utils.ts` в `src/utils/cn.ts`, чтобы его название отражало его единственное предназначение (classnames).
  - Удалить неиспользуемый файл стилей `src/App.css`.

---

### **Этап 3: Рефакторинг компонентов и логики**

- [ ] **3.1. Создать хук для управления кредитами:**
  - Создать кастомный хук `src/hooks/useCredits.ts`, который инкапсулирует всю логику получения и обновления баланса кредитов пользователя.

- [ ] **3.2. Рефакторинг компонентов для использования `useCredits`:**
  - Обновить `Index.tsx` и `Dashboard.tsx`, чтобы они использовали хук `useCredits.ts` для получения данных о кредитах, устраняя дублирование кода.

- [ ] **3.3. Создать хук для логики поиска:**
  - Создать кастомный хук `src/hooks/useSearch.ts`, который инкапсулирует всю логику поиска изображений: управление состоянием загрузки, отправку запроса, обработку ошибок и результатов.

- [ ] **3.4. Рефакторинг `Index.tsx`:**
  - Упростить `Index.tsx`, используя хук `useSearch.ts`. Компонент должен отвечать только за отображение UI, передавая пользовательский ввод в хук.

- [ ] **3.5. Централизовать навигацию:**
  - Заменить все оставшиеся использования `window.location.href` и `window.location.reload()` на хук `useNavigate` из `react-router-dom` для плавной навигации без перезагрузки страницы.

---

### **Этап 4: Улучшение качества кода и типизации**

- [ ] **4.1. Включить строгий режим TypeScript:**
  - В `tsconfig.json` установить `"strict": true`.

- [ ] **4.2. Исправить ошибки типизации:**
  - Пройти по проекту и исправить все ошибки, которые появятся после включения строгого режима.

- [ ] **4.3. Определить типы для API:**
  - Создать файл `src/types/api.ts`.
  - Определить в нем все необходимые интерфейсы для ответов от API (результаты поиска, данные пользователя, баланс кредитов).

- [ ] **4.4. Настроить удаление `console.log`:**
  - Обновить конфигурацию Vite (`vite.config.ts`), чтобы `console.log` и `console.error` автоматически удалялись из продакшн-сборки.
